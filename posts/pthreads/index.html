<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>pthreads in C - George&#39;s Blog</title><meta name="Description" content="Welcome to George&#39;s Blog"><meta property="og:title" content="pthreads in C" />
<meta property="og:description" content="This tutorial assumes you know the basic concepts of multithreading. It is based on this short video series by Dr. Brian Fraser
Creating single threads The pthread library (POSTIX thread) allows C programmers to use multithreading capabilities. First you must define the &lt;pthread.h&gt; header, and link -pthread when compiling the program. The function to create a thread is the pthread_create():
&lt;pthread.h&gt; int pthread_create(pthread_t *thread, const pthread_attr_t *attr, void *(*start_routine) (void *), void *arg); This takes 4 different parameters:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/georgesims21.github.io/posts/pthreads/" /><meta property="og:image" content="/logo.png"/><meta property="article:section" content="posts" />

<meta property="og:site_name" content="George&#39;s Blog" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/logo.png"/>

<meta name="twitter:title" content="pthreads in C"/>
<meta name="twitter:description" content="This tutorial assumes you know the basic concepts of multithreading. It is based on this short video series by Dr. Brian Fraser
Creating single threads The pthread library (POSTIX thread) allows C programmers to use multithreading capabilities. First you must define the &lt;pthread.h&gt; header, and link -pthread when compiling the program. The function to create a thread is the pthread_create():
&lt;pthread.h&gt; int pthread_create(pthread_t *thread, const pthread_attr_t *attr, void *(*start_routine) (void *), void *arg); This takes 4 different parameters:"/>
<meta name="application-name" content="George&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="George&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="/georgesims21.github.io/posts/pthreads/" /><link rel="prev" href="/georgesims21.github.io/posts/socket_programming/" /><link rel="next" href="/georgesims21.github.io/posts/procfs/" /><link rel="stylesheet" href="/georgesims21.github.io/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "pthreads in C",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "\/georgesims21.github.io\/posts\/pthreads\/"
        },"genre": "posts","keywords": "C, Multithreading","wordcount":  1379 ,
        "url": "\/georgesims21.github.io\/posts\/pthreads\/","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "George Sims"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/georgesims21.github.io/" title="George&#39;s Blog"><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/georgesims21.github.io/posts/" title="Posts"> Posts </a><a class="menu-item" href="/georgesims21.github.io/tags/"> Tags </a><a class="menu-item" href="/georgesims21.github.io/categories/"> Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/georgesims21.github.io/" title="George&#39;s Blog"><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/georgesims21.github.io/posts/" title="Posts">Posts</a><a class="menu-item" href="/georgesims21.github.io/tags/" title="">Tags</a><a class="menu-item" href="/georgesims21.github.io/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">pthreads in C</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/georgesims21" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>George Sims</a></span>&nbsp;<span class="post-category">included in <a href="/georgesims21.github.io/categories/tutorial/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Tutorial</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="0001-01-01">0001-01-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;1379 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;7 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#creating-single-threads">Creating single threads</a></li>
    <li><a href="#returning-a-value-from-the-run-function">Returning a value from the run function</a></li>
    <li><a href="#giving-multiple-parameters-to-the-run-function">Giving multiple parameters to the run function</a></li>
    <li><a href="#creating-multiple-threads">Creating multiple threads</a></li>
    <li><a href="#multiple-threads-having-own-param-variables">Multiple threads having own param variables</a></li>
    <li><a href="#thread-syncronization">Thread syncronization</a>
      <ul>
        <li><a href="#mutexes">Mutexes</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>This tutorial assumes you know the basic concepts of multithreading. It is based on <a href="https://www.youtube.com/watch?v=ynCc-v0K-do&amp;t=5s" target="_blank" rel="noopener noreffer ">this short video series by Dr. Brian Fraser</a></p>
<h2 id="creating-single-threads">Creating single threads</h2>
<p>The pthread library (POSTIX thread) allows C programmers to use multithreading capabilities. First you must define the &lt;pthread.h&gt; header, and link -pthread when compiling the program.
The function to create a thread is the pthread_create():</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>pthread.h<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> pthread_create(pthread_t <span style="color:#f92672">*</span><span style="color:#66d9ef">thread</span>, <span style="color:#66d9ef">const</span> pthread_attr_t <span style="color:#f92672">*</span>attr, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>start_routine) (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>), <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>arg);
</span></span></code></pre></div><p>This takes 4 different parameters:</p>
<ul>
<li>The pthread_t thread variable you wish to use</li>
<li>Any special attributes you wish this thread to have contained in the pthread_attr_t struct</li>
<li>The routine you want this thread to do. This will be a function pointer, and this pointer should return a void* as well as accepting void* as params.</li>
<li>Finally any arguments you wish to pass to this routine</li>
</ul>
<p>From this it is important to point out that threads can only run routines which return and take void pointer types. This means casting must be done within the routine if you wish to use particular variables.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;pthread.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* Simply allow a thread to increment a global variable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> limit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// global as threads share address space
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">run</span>(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> arg) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>lim <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)arg; <span style="color:#75715e">// must cast the void pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// int lim = *(int *)arg; would dereference and place value in lim instead
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    printf(<span style="color:#e6db74">&#34;Thread running, before incrementing limit is: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, limit);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>lim <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>lim <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;Thread running, after incrementing limit is: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, limit);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pthread_exit(<span style="color:#ae81ff">0</span>); 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;In main before thread, limit is: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, limit);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// create thread
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pthread_t tid;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// create attributes - can also pass NULL if not needed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pthread_attr_t attr;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// init attributes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pthread_attr_init(<span style="color:#f92672">&amp;</span>attr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// create and run thread
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pthread_create(<span style="color:#f92672">&amp;</span>tid, <span style="color:#f92672">&amp;</span>attr, run, <span style="color:#f92672">&amp;</span>limit); <span style="color:#75715e">// run is function pointer as without
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                              <span style="color:#75715e">// paranthesis it points to starting 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                              <span style="color:#75715e">// address of function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// wait for thread to finish
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pthread_join(tid, NULL); <span style="color:#75715e">// if param 2 is NULL, main ignores any return value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;In main after thread, limit is: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, limit);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}      
</span></span></code></pre></div><p>The output of such program should look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>➜  ~ gcc -Wall threads.c -lpthread -o threads
</span></span><span style="display:flex;"><span>➜  ~ ./threads  
</span></span><span style="display:flex;"><span>In main before thread, limit is: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Thread running, before incrementing limit is: <span style="color:#ae81ff">0</span> <span style="color:#75715e"># Thread is running </span>
</span></span><span style="display:flex;"><span>Thread running, after incrementing limit is: <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># while main waits</span>
</span></span><span style="display:flex;"><span>In main after thread, limit is: <span style="color:#ae81ff">1</span>   
</span></span></code></pre></div><p>It is important to note that without the pthread_join function in this program, the main thread would simply print the statement and return without giving the thread a chance.</p>
<h2 id="returning-a-value-from-the-run-function">Returning a value from the run function</h2>
<p>In the previous example a global variable was used. If you want to return a variable from the function you must use pthread_exit(<!-- raw HTML omitted -->) and catch it when using pthread_join like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">run</span>(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> arg) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> value;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    pthread_exit(<span style="color:#f92672">&amp;</span>value); <span style="color:#75715e">// auto-converted to void* by method
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>retval;
</span></span><span style="display:flex;"><span>    pthread_join(tid, (<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)<span style="color:#f92672">&amp;</span>retval); <span style="color:#75715e">// join returns ptr to ptr of type void
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ...
</span></span><span style="display:flex;"><span>}      
</span></span></code></pre></div><h2 id="giving-multiple-parameters-to-the-run-function">Giving multiple parameters to the run function</h2>
<p>The problem with having the void* as a parameter for the run function is giving more than one argument. The only way to pass more than one would be to create a struct containing all of the variables that you wish to pass to the function. It is good practice to name this similar to the function itself:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> run_struct { <span style="color:#75715e">// name matching function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> limit; 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> answer;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">run</span>(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> arg) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> run_struct <span style="color:#f92672">*</span>args <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> run_struct <span style="color:#f92672">*</span>) arg; <span style="color:#75715e">// typecast to use vars
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    args<span style="color:#f92672">-&gt;</span>answer <span style="color:#f92672">=</span> args<span style="color:#f92672">-&gt;</span>limit<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> run_struct rs <span style="color:#f92672">=</span> {<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    pthread_create(<span style="color:#f92672">&amp;</span>tid, <span style="color:#f92672">&amp;</span>attr, run, <span style="color:#f92672">&amp;</span>rs); <span style="color:#75715e">// here the struct is given as param
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ...
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;In main after thread, answer is: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, rs.answer);
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><h2 id="creating-multiple-threads">Creating multiple threads</h2>
<p>Multiple threads can be created using a for loop:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pthread_t tids[<span style="color:#ae81ff">10</span>]; <span style="color:#75715e">// create array of threads size 10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// this can be done here for each or you can use one pthread_attr_t for
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// all threads, if you wish them to have the same attributes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pthread_attr_t attr;
</span></span><span style="display:flex;"><span>    pthread_attr_init(<span style="color:#f92672">&amp;</span>attr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pthread_create(<span style="color:#f92672">&amp;</span>tids[i], <span style="color:#f92672">&amp;</span>attr, run, <span style="color:#f92672">&amp;</span>limit); <span style="color:#75715e">// create 10 threads
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    pthread_join(tids[i], NULL); <span style="color:#75715e">// make main wait for all of them
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h2 id="multiple-threads-having-own-param-variables">Multiple threads having own param variables</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;pthread.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* Allow multiple threads to increment their own struct variable and save into the other
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* then main waits and prints. - Doesn&#39;t increment but too lazy to change
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> run_struct {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> limit;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> answer;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> tn;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">run</span>(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> arg) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> run_struct <span style="color:#f92672">*</span>args <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> run_struct <span style="color:#f92672">*</span>) arg;
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;Thread[%d] running, before incrementing answer is: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, args<span style="color:#f92672">-&gt;</span>tn, 
</span></span><span style="display:flex;"><span>                                                                      args<span style="color:#f92672">-&gt;</span>answer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    args<span style="color:#f92672">-&gt;</span>answer <span style="color:#f92672">=</span> args<span style="color:#f92672">-&gt;</span>limit<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;Thread[%d] running, after incrementing answer is: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, args<span style="color:#f92672">-&gt;</span>tn, 
</span></span><span style="display:flex;"><span>                                                                     args<span style="color:#f92672">-&gt;</span>answer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pthread_exit(<span style="color:#ae81ff">0</span>); 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> run_struct rs[<span style="color:#ae81ff">10</span>]; <span style="color:#75715e">// to give all threads own variables for function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        rs[i].limit <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>        rs[i].answer <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        rs[i].tn <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// create threads
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pthread_t tids[<span style="color:#ae81ff">10</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pthread_attr_t attr;
</span></span><span style="display:flex;"><span>    pthread_attr_init(<span style="color:#f92672">&amp;</span>attr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// create and run threads with threads own param struct
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        rs[i].tn <span style="color:#f92672">=</span> i; <span style="color:#75715e">// give thread it&#39;s own tid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        pthread_create(<span style="color:#f92672">&amp;</span>tids[i], <span style="color:#f92672">&amp;</span>attr, run, <span style="color:#f92672">&amp;</span>rs[i]); <span style="color:#75715e">// each thread gives own 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                                      <span style="color:#75715e">// struct as param pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// wait for thread to finish
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        pthread_join(tids[i], NULL); <span style="color:#75715e">// if param 2 is NULL, main ignores any return value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        printf(<span style="color:#e6db74">&#34;In main after thread[%d], limit is: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, i, rs[i].answer);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}       
</span></span></code></pre></div><p>If you compile and run the above program, you will see that the order of execution is only kept when main is printing the variables due to the wait function, but the threads themselves can finish before the others without order.. but main won&rsquo;t print information for a thread if the one before hasn&rsquo;t finished. Example output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>➜  ~ gcc -Wall threads.c -lpthread -o threads
</span></span><span style="display:flex;"><span>➜  ~ ./threads
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> running, before incrementing answer is: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> running, after incrementing answer is: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> running, before incrementing answer is: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>4<span style="color:#f92672">]</span> running, before incrementing answer is: <span style="color:#ae81ff">0</span> <span style="color:#75715e"># not in order </span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span> running, before incrementing answer is: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span> running, after incrementing answer is: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span> running, before incrementing answer is: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>5<span style="color:#f92672">]</span> running, before incrementing answer is: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>5<span style="color:#f92672">]</span> running, after incrementing answer is: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>In main after thread<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>, limit is: <span style="color:#ae81ff">5</span> <span style="color:#75715e"># Thread[0] has finished so main can print it</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>4<span style="color:#f92672">]</span> running, after incrementing answer is: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>8<span style="color:#f92672">]</span> running, before incrementing answer is: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>8<span style="color:#f92672">]</span> running, after incrementing answer is: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span> running, after incrementing answer is: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>3<span style="color:#f92672">]</span> running, before incrementing answer is: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>3<span style="color:#f92672">]</span> running, after incrementing answer is: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> running, after incrementing answer is: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>9<span style="color:#f92672">]</span> running, before incrementing answer is: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>9<span style="color:#f92672">]</span> running, after incrementing answer is: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>In main after thread<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>, limit is: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>In main after thread<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>, limit is: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>In main after thread<span style="color:#f92672">[</span>3<span style="color:#f92672">]</span>, limit is: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>In main after thread<span style="color:#f92672">[</span>4<span style="color:#f92672">]</span>, limit is: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>In main after thread<span style="color:#f92672">[</span>5<span style="color:#f92672">]</span>, limit is: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>In main after thread<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>, limit is: <span style="color:#ae81ff">5</span> <span style="color:#75715e"># 8 will not be printed until 7 is finished</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>7<span style="color:#f92672">]</span> running, before incrementing answer is: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Thread<span style="color:#f92672">[</span>7<span style="color:#f92672">]</span> running, after incrementing answer is: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>In main after thread<span style="color:#f92672">[</span>7<span style="color:#f92672">]</span>, limit is: <span style="color:#ae81ff">5</span> <span style="color:#75715e"># now 7 is done 8 can proceed</span>
</span></span><span style="display:flex;"><span>In main after thread<span style="color:#f92672">[</span>8<span style="color:#f92672">]</span>, limit is: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>In main after thread<span style="color:#f92672">[</span>9<span style="color:#f92672">]</span>, limit is: <span style="color:#ae81ff">5</span>
</span></span></code></pre></div><h2 id="thread-syncronization">Thread syncronization</h2>
<h3 id="mutexes">Mutexes</h3>
<p>When threads modify the same address or variable, there is no telling which will go first and most likely without any form of syncronisation you will get race conditions.It is important to correctly identify the critical section(s) within the code and add some form of syncronisation to that area, so only one thread at a time can access this area. A mutex (or mutual exclusion) allows for such a scenario.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>pthread_mutex_t mutex <span style="color:#f92672">=</span> PTHREAD_MUTEX_INITIALIZER; <span style="color:#75715e">// macro used for init of mutex
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e">// critical section start
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>pthread_mutex_lock(<span style="color:#f92672">&amp;</span>mutex);
</span></span><span style="display:flex;"><span>... <span style="color:#75715e">// only 1 thread can acess this area of code
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>pthread_mutex_unlock(<span style="color:#f92672">&amp;</span>mutex);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// critical section end
</span></span></span></code></pre></div><p>Keep in mind however that mutexes should only be used when needed as they make expensive calls to the kernel.
Further reading: <a href="https://nachtimwald.com/2019/04/12/thread-pool-in-c/" target="_blank" rel="noopener noreffer ">Implementing thread pools in C</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 0001-01-01</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="/georgesims21.github.io/posts/pthreads/" data-title="pthreads in C" data-hashtags="C,Multithreading"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="/georgesims21.github.io/posts/pthreads/" data-hashtag="C"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="/georgesims21.github.io/posts/pthreads/" data-title="pthreads in C"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="/georgesims21.github.io/posts/pthreads/" data-title="pthreads in C"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.0.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="/georgesims21.github.io/posts/pthreads/" data-title="pthreads in C"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/georgesims21.github.io/tags/c/">C</a>,&nbsp;<a href="/georgesims21.github.io/tags/multithreading/">Multithreading</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/georgesims21.github.io/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/georgesims21.github.io/posts/socket_programming/" class="prev" rel="prev" title="Socket Programming (TCP)"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Socket Programming (TCP)</a>
            <a href="/georgesims21.github.io/posts/procfs/" class="next" rel="next" title="procfs/sysfs">procfs/sysfs<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.101.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/georgesims21" target="_blank">George Sims</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@8.6.0/dist/index.umd.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"data":{"id-1":"George's Blog","id-2":"George's Blog"},"search":{"highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/georgesims21.github.io/js/theme.min.js"></script></body>
</html>
